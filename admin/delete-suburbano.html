<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delete Suburbano Zone Type - RED TV</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .button:hover {
            background: #c82333;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .button.info {
            background: #17a2b8;
        }
        .button.info:hover {
            background: #138496;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .warning-box h3 {
            color: #856404;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è Delete "Suburbano" Zone Type</h1>
        <p>This tool will safely remove the "Suburbano" zone type from your database.</p>
        
        <div class="warning-box">
            <h3>‚ö†Ô∏è Warning</h3>
            <p><strong>This action will:</strong></p>
            <ul>
                <li>Delete the "Suburbano" zone type</li>
                <li>Remove all plan availability records that use "Suburbano"</li>
                <li>This action cannot be undone</li>
            </ul>
            <p>Make sure you want to proceed before clicking the delete button.</p>
        </div>
        
        <div id="status" class="status error">
            ‚ö†Ô∏è Initializing...
        </div>
        
        <div>
            <button class="button info" onclick="checkSuburbano()" id="btn-check">üîç Check Suburbano Usage</button>
            <button class="button" onclick="deleteSuburbano()" id="btn-delete" disabled>üóëÔ∏è Delete Suburbano</button>
            <button class="button info" onclick="clearLog()">üßπ Clear Log</button>
        </div>
        
        <div id="log" class="log">Initializing...\n</div>
    </div>

    <!-- Load Supabase from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="module">
        import { initSupabase, getSupabase } from './js/supabase-cdn.js';
        
        const logElement = document.getElementById('log');
        const statusElement = document.getElementById('status');
        const checkBtn = document.getElementById('btn-check');
        const deleteBtn = document.getElementById('btn-delete');
        
        let suburbanoZoneType = null;
        
        function log(message) {
            logElement.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function setStatus(message, type = 'error') {
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                log('üîÑ Initializing Supabase client...');
                await initSupabase();
                log('‚úÖ Supabase client initialized successfully!');
                setStatus('‚úÖ Ready! Click "Check Suburbano Usage" to analyze the data.', 'success');
            } catch (error) {
                log('‚ùå Failed to initialize Supabase: ' + error.message);
                setStatus('‚ùå Initialization failed: ' + error.message, 'error');
            }
        });
        
        // Check Suburbano usage
        async function checkSuburbano() {
            log('üîç Checking "Suburbano" zone type usage...');
            checkBtn.disabled = true;
            
            try {
                const client = getSupabase();
                
                // 1. Find the Suburbano zone type
                const { data: zoneTypes, error: zoneError } = await client
                    .from('zone_types')
                    .select('*')
                    .eq('name', 'Suburbano');
                
                if (zoneError) throw zoneError;
                
                if (zoneTypes.length === 0) {
                    log('‚ÑπÔ∏è  "Suburbano" zone type not found in database');
                    setStatus('‚ÑπÔ∏è  "Suburbano" zone type not found. Nothing to delete.', 'warning');
                    return;
                }
                
                suburbanoZoneType = zoneTypes[0];
                log(`‚úÖ Found "Suburbano" zone type with ID: ${suburbanoZoneType.id}`);
                
                // 2. Check plan availability using this zone type
                const { data: availability, error: availError } = await client
                    .from('plan_availability')
                    .select(`
                        *,
                        plans (name),
                        localities (name)
                    `)
                    .eq('zone_type_id', suburbanoZoneType.id);
                
                if (availError) throw availError;
                
                log(`üìä Found ${availability.length} plan availability records using "Suburbano"`);
                
                if (availability.length > 0) {
                    log('üìã Plans affected:');
                    const plansByLocality = {};
                    
                    availability.forEach(avail => {
                        const locality = avail.localities.name;
                        const plan = avail.plans.name;
                        
                        if (!plansByLocality[locality]) {
                            plansByLocality[locality] = [];
                        }
                        plansByLocality[locality].push(plan);
                    });
                    
                    Object.keys(plansByLocality).forEach(locality => {
                        log(`   üìç ${locality}:`);
                        plansByLocality[locality].forEach(plan => {
                            log(`      - ${plan}`);
                        });
                    });
                }
                
                // 3. Enable delete button
                deleteBtn.disabled = false;
                setStatus(`‚úÖ Analysis complete. Found ${availability.length} records to delete.`, 'warning');
                log('‚úÖ Analysis complete. You can now proceed with deletion if desired.');
                
            } catch (error) {
                log('‚ùå Error checking Suburbano usage: ' + error.message);
                setStatus('‚ùå Error during analysis: ' + error.message, 'error');
            } finally {
                checkBtn.disabled = false;
            }
        }
        
        // Delete Suburbano zone type
        async function deleteSuburbano() {
            if (!suburbanoZoneType) {
                log('‚ùå No Suburbano zone type found. Run check first.');
                return;
            }
            
            const confirmed = confirm(
                'Are you sure you want to delete the "Suburbano" zone type?\n\n' +
                'This will remove all plan availability records that use this zone type.\n\n' +
                'This action cannot be undone!'
            );
            
            if (!confirmed) {
                log('‚ùå Deletion cancelled by user');
                return;
            }
            
            log('üóëÔ∏è  Starting deletion of "Suburbano" zone type...');
            deleteBtn.disabled = true;
            
            try {
                const client = getSupabase();
                
                // 1. Delete plan availability records first
                log('üóëÔ∏è  Deleting plan availability records...');
                const { error: availError } = await client
                    .from('plan_availability')
                    .delete()
                    .eq('zone_type_id', suburbanoZoneType.id);
                
                if (availError) throw availError;
                log('‚úÖ Plan availability records deleted');
                
                // 2. Delete the zone type
                log('üóëÔ∏è  Deleting "Suburbano" zone type...');
                const { error: zoneError } = await client
                    .from('zone_types')
                    .delete()
                    .eq('id', suburbanoZoneType.id);
                
                if (zoneError) throw zoneError;
                log('‚úÖ "Suburbano" zone type deleted successfully');
                
                // 3. Verify deletion
                const { data: verification, error: verifyError } = await client
                    .from('zone_types')
                    .select('*')
                    .eq('name', 'Suburbano');
                
                if (verifyError) throw verifyError;
                
                if (verification.length === 0) {
                    log('‚úÖ Deletion verified - "Suburbano" no longer exists');
                    setStatus('‚úÖ "Suburbano" zone type deleted successfully!', 'success');
                } else {
                    log('‚ö†Ô∏è  Warning: "Suburbano" still exists after deletion');
                    setStatus('‚ö†Ô∏è  Deletion may not have completed properly', 'warning');
                }
                
                suburbanoZoneType = null;
                
            } catch (error) {
                log('‚ùå Error deleting Suburbano: ' + error.message);
                setStatus('‚ùå Error during deletion: ' + error.message, 'error');
            } finally {
                deleteBtn.disabled = true;
            }
        }
        
        // Clear log
        function clearLog() {
            logElement.textContent = 'Log cleared...\n';
        }
        
        // Make functions available globally
        window.checkSuburbano = checkSuburbano;
        window.deleteSuburbano = deleteSuburbano;
        window.clearLog = clearLog;
    </script>
</body>
</html> 